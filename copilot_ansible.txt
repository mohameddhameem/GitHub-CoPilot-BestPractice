# GitHub Copilot Instructions - Ansible Infrastructure

## Ansible Best Practices

### Playbook Structure
- Use role-based organization
- One task per file when appropriate
- Meaningful role and task names that describe intent
- Use `block` for error handling with `rescue` and `always`
- Keep inventories versioned; prefer group_vars/host_vars with dynamic inventory scripts where appropriate

### Variables and Templates
- Use `group_vars/` and `host_vars/` for variable organization
- Prefix role variables with role name to avoid conflicts
- Use Jinja2 templates with proper escaping
- Validate variables with `assert` module before use

### Idempotency
- All tasks must be idempotent
- Use `changed_when` to control change reporting
- Use `check_mode` compatible modules
- Test playbooks in check mode before execution

### Security
- Use Ansible Vault for sensitive data
- Never commit unencrypted secrets
- Use `no_log: true` for sensitive task output
- Implement least privilege for SSH users and sudo access
- Rotate vault keys periodically; document key ownership and storage

### Error Handling
- Use `failed_when` for custom failure conditions
- Implement proper `rescue` blocks
- Log failures with context
- Validate prerequisites before execution

### Code Quality
- Use `ansible-lint` and fix all issues
- Follow YAML formatting: 2-space indentation
- Use full module names (not deprecated short forms)
- Document complex conditionals and loops
- Keep pre-commit hook to run ansible-lint and yamllint (lint/format only)

### Documentation
- Maintain README.md with:
  - Inventory structure
  - Required variables
  - Execution instructions
  - Dependencies and prerequisites
- Document custom modules and filters
- Keep role meta/main.yml updated

### Testing
- Test playbooks against multiple OS versions
- Use `--syntax-check` before execution
- Validate with `--check` mode
- Test rollback procedures
- Use Molecule for role testing; run locally before merging

### Performance and Execution Strategy
- Set `serial` and `max_fail_percentage` deliberately for controlled rollout
- Tune `forks` for environment size; avoid overloading controllers/targets
- Consider `strategy: free` only when safe; default to linear for predictable ordering

### Inventory and Execution Docs
- Document dynamic inventory sources and required credentials
- Keep README updated with sample `ansible-playbook` commands, tags, and limits

## Example Structure
```yaml
# Good: Clear, idempotent, with error handling
- name: Ensure application service is running
  block:
    - name: Validate service configuration exists
      ansible.builtin.stat:
        path: /etc/app/config.yml
      register: config_check
      
    - name: Fail if configuration missing
      ansible.builtin.fail:
        msg: "Configuration file not found at /etc/app/config.yml"
      when: not config_check.stat.exists
      
    - name: Start application service
      ansible.builtin.systemd:
        name: app-service
        state: started
        enabled: true
      register: service_result
      
    - name: Log service start
      ansible.builtin.debug:
        msg: "Service started: {{ service_result.changed }}"
        
  rescue:
    - name: Log service start failure
      ansible.builtin.debug:
        msg: "Failed to start service: {{ ansible_failed_result.msg }}"
        
    - name: Notify administrators
      ansible.builtin.mail:
        subject: "Service start failed on {{ inventory_hostname }}"
        body: "{{ ansible_failed_result }}"
```

## TODO Management
Maintain TODO.md with:
- Infrastructure tasks pending
- Playbook refactoring needed
- Security improvements required
- Documentation gaps